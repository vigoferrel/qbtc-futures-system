<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QBTC Dashboard - Sistema de Control Real-Time</title>
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #0f4c75;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --quantum: #8a2be2;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: rgba(0,0,0,0.3);
            padding: 1rem 2rem;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--gold);
        }

        .status-indicators {
            display: flex;
            gap: 1rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 80px);
        }

        .sidebar {
            background: rgba(0,0,0,0.2);
            padding: 1rem;
            border-right: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }

        .content {
            padding: 1rem;
            overflow-y: auto;
        }

        .control-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(5px);
        }

        .control-panel h3 {
            color: var(--gold);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .trading-mode-selector {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .mode-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .mode-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .mode-btn.active {
            background: var(--quantum);
            border-color: var(--gold);
        }

        .tier-filters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.3rem;
            margin-top: 0.5rem;
        }

        .tier-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 0.3rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .tier-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .tier-btn.active {
            background: var(--info);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .dashboard-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 1rem;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .dashboard-card h3 {
            color: var(--gold);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .metric-value {
            font-weight: bold;
        }

        .metric-value.positive {
            color: var(--success);
        }

        .metric-value.negative {
            color: var(--danger);
        }

        .symbols-table {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            backdrop-filter: blur(5px);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }

        .table th {
            background: rgba(0,0,0,0.3);
            color: var(--gold);
            font-weight: bold;
        }

        .tier-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .tier-1 { background: var(--gold); color: black; }
        .tier-2 { background: var(--silver); color: black; }
        .tier-3 { background: var(--bronze); color: white; }
        .tier-4 { background: var(--info); color: white; }
        .tier-5 { background: var(--warning); color: black; }
        .tier-6 { background: var(--danger); color: white; }

        .progress-bar {
            background: rgba(255,255,255,0.1);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--info));
            transition: width 0.3s ease;
        }

        .opportunity-item {
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--quantum);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gold);
        }

        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid var(--gold);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .connection-status {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            display: inline-block;
        }

        .connected {
            background: var(--success);
            color: white;
        }

        .disconnected {
            background: var(--danger);
            color: white;
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üéØ QBTC Dashboard</div>
        <div class="status-indicators">
            <span id="merkaba-status" class="connection-status disconnected">Merkaba: Disconnected</span>
            <span id="frontend-status" class="connection-status connected">Frontend: Online</span>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="control-panel">
                <h3>üéÆ Control de Trading</h3>
                <div class="trading-mode-selector">
                    <button class="mode-btn active" data-mode="BALANCED">BALANCED</button>
                    <button class="mode-btn" data-mode="CONSERVATIVE">CONSERVATIVE</button>
                    <button class="mode-btn" data-mode="AGGRESSIVE">AGGRESSIVE</button>
                    <button class="mode-btn" data-mode="EXTREME">EXTREME</button>
                </div>
            </div>

            <div class="control-panel">
                <h3>üèÜ Filtros por Tier</h3>
                <div class="tier-filters">
                    <button class="tier-btn active" data-tier="ALL">ALL</button>
                    <button class="tier-btn" data-tier="TIER1">T1</button>
                    <button class="tier-btn" data-tier="TIER2">T2</button>
                    <button class="tier-btn" data-tier="TIER3">T3</button>
                    <button class="tier-btn" data-tier="TIER4">T4</button>
                    <button class="tier-btn" data-tier="TIER5">T5</button>
                    <button class="tier-btn" data-tier="TIER6">T6</button>
                </div>
            </div>

            <div class="control-panel">
                <h3>üìä M√©tricas del Sistema</h3>
                <div id="system-metrics">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando m√©tricas...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="dashboard-grid" id="dashboard-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Cargando dashboard...</p>
                </div>
            </div>

            <div class="symbols-table">
                <h3>üìà S√≠mbolos Activos por Tier</h3>
                <div id="symbols-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando s√≠mbolos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        class QBTCDashboard {
            constructor() {
                this.currentMode = 'BALANCED';
                this.currentTier = 'ALL';
                this.data = {
                    tiers: null,
                    symbols: null,
                    tradingModes: null,
                    merkabaStatus: null,
                    opportunities: null
                };
                this.updateInterval = null;
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadAllData();
                this.startRealTimeUpdates();
            }

            setupEventListeners() {
                // Botones de modo de trading
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentMode = e.target.dataset.mode;
                        this.loadSymbols();
                        this.updateDashboard();
                    });
                });

                // Botones de filtro por tier
                document.querySelectorAll('.tier-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentTier = e.target.dataset.tier;
                        this.updateSymbolsDisplay();
                    });
                });
            }

            async loadAllData() {
                try {
                    await Promise.all([
                        this.loadTiers(),
                        this.loadSymbols(),
                        this.loadTradingModes(),
                        this.checkMerkabaStatus(),
                        this.loadOpportunities()
                    ]);
                    this.updateDashboard();
                } catch (error) {
                    console.error('Error cargando datos:', error);
                }
            }

            async loadTiers() {
                try {
                    const response = await fetch('/api/qbtc/tiers');
                    this.data.tiers = await response.json();
                } catch (error) {
                    console.error('Error loading tiers:', error);
                }
            }

            async loadSymbols() {
                try {
                    const response = await fetch(`/api/qbtc/symbols?mode=${this.currentMode}`);
                    this.data.symbols = await response.json();
                } catch (error) {
                    console.error('Error loading symbols:', error);
                }
            }

            async loadTradingModes() {
                try {
                    const response = await fetch('/api/qbtc/trading-modes');
                    this.data.tradingModes = await response.json();
                } catch (error) {
                    console.error('Error loading trading modes:', error);
                }
            }

            async checkMerkabaStatus() {
                try {
                    const response = await fetch('/api/qbtc/merkaba-status');
                    this.data.merkabaStatus = await response.json();
                    this.updateMerkabaStatus();
                } catch (error) {
                    console.error('Error checking Merkaba status:', error);
                }
            }

            async loadOpportunities() {
                try {
                    const response = await fetch(`/api/qbtc/opportunities?mode=${this.currentMode}`);
                    this.data.opportunities = await response.json();
                } catch (error) {
                    console.error('Error loading opportunities:', error);
                }
            }

            updateMerkabaStatus() {
                const statusEl = document.getElementById('merkaba-status');
                if (this.data.merkabaStatus && this.data.merkabaStatus.backend_connected) {
                    statusEl.className = 'connection-status connected';
                    statusEl.textContent = 'Merkaba: Connected';
                } else {
                    statusEl.className = 'connection-status disconnected';
                    statusEl.textContent = 'Merkaba: Disconnected';
                }
            }

            updateDashboard() {
                this.updateTierCards();
                this.updateSystemMetrics();
                this.updateSymbolsDisplay();
            }

            updateTierCards() {
                if (!this.data.tiers) return;

                const grid = document.getElementById('dashboard-grid');
                grid.innerHTML = '';

                // Card resumen general
                const summaryCard = document.createElement('div');
                summaryCard.className = 'dashboard-card';
                summaryCard.innerHTML = `
                    <h3>üìä Resumen General</h3>
                    <div class="metric">
                        <span>Total S√≠mbolos:</span>
                        <span class="metric-value">${this.data.tiers.total_symbols}</span>
                    </div>
                    <div class="metric">
                        <span>Total Tiers:</span>
                        <span class="metric-value">${this.data.tiers.total_tiers}</span>
                    </div>
                    <div class="metric">
                        <span>Modo Actual:</span>
                        <span class="metric-value">${this.currentMode}</span>
                    </div>
                    <div class="metric">
                        <span>S√≠mbolos Activos:</span>
                        <span class="metric-value">${this.data.symbols ? this.data.symbols.total_symbols : 0}</span>
                    </div>
                `;
                grid.appendChild(summaryCard);

                // Cards por tier
                this.data.tiers.tiers.forEach(tier => {
                    const card = document.createElement('div');
                    card.className = 'dashboard-card';
                    
                    const dailyPnlClass = tier.current_metrics.daily_pnl >= 0 ? 'positive' : 'negative';
                    const winrateClass = tier.current_metrics.current_winrate >= tier.performance.win_rate_target ? 'positive' : 'negative';
                    
                    card.innerHTML = `
                        <h3><span class="tier-badge tier-${tier.tier.toLowerCase().replace('tier', '')}">${tier.tier}</span> (${tier.symbol_count})</h3>
                        <div class="metric">
                            <span>PnL Diario:</span>
                            <span class="metric-value ${dailyPnlClass}">${(tier.current_metrics.daily_pnl * 100).toFixed(2)}%</span>
                        </div>
                        <div class="metric">
                            <span>Drawdown:</span>
                            <span class="metric-value">${(tier.current_metrics.current_drawdown * 100).toFixed(2)}%</span>
                        </div>
                        <div class="metric">
                            <span>Win Rate:</span>
                            <span class="metric-value ${winrateClass}">${(tier.current_metrics.current_winrate * 100).toFixed(1)}%</span>
                        </div>
                        <div class="metric">
                            <span>Posiciones:</span>
                            <span class="metric-value">${tier.current_metrics.active_positions}</span>
                        </div>
                        <div class="metric">
                            <span>Coherencia:</span>
                            <span class="metric-value">${tier.current_metrics.coherence_level.toFixed(3)}</span>
                        </div>
                        <div class="metric">
                            <span>Volatilidad:</span>
                            <span class="metric-value">${tier.performance.volatility}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${tier.current_metrics.coherence_level * 100}%"></div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            updateSystemMetrics() {
                const metricsEl = document.getElementById('system-metrics');
                
                if (!this.data.tradingModes) {
                    metricsEl.innerHTML = '<div class="loading"><div class="spinner"></div><p>Cargando...</p></div>';
                    return;
                }

                const currentModeData = this.data.tradingModes.modes.find(m => m.mode === this.currentMode);
                
                metricsEl.innerHTML = `
                    <div class="metric">
                        <span>Max Posiciones:</span>
                        <span class="metric-value">${currentModeData?.config.max_positions || 'N/A'}</span>
                    </div>
                    <div class="metric">
                        <span>Riesgo por Trade:</span>
                        <span class="metric-value">${((currentModeData?.config.risk_per_trade || 0) * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric">
                        <span>Leverage M√°ximo:</span>
                        <span class="metric-value">${currentModeData?.config.leverage_limit || 'N/A'}x</span>
                    </div>
                    <div class="metric">
                        <span>PnL Actual:</span>
                        <span class="metric-value positive">$${currentModeData?.current_status.current_pnl?.toFixed(2) || '0.00'}</span>
                    </div>
                    <div class="metric">
                        <span>Uso de Riesgo:</span>
                        <span class="metric-value">${((currentModeData?.current_status.risk_usage || 0) * 100).toFixed(1)}%</span>
                    </div>
                `;

                // A√±adir oportunidades si est√°n disponibles
                if (this.data.opportunities) {
                    metricsEl.innerHTML += `
                        <hr style="margin: 0.5rem 0; border: 1px solid rgba(255,255,255,0.2);">
                        <div class="metric">
                            <span>Oportunidades:</span>
                            <span class="metric-value">${this.data.opportunities.triangular_opportunities}</span>
                        </div>
                    `;
                }
            }

            updateSymbolsDisplay() {
                const container = document.getElementById('symbols-container');
                
                if (!this.data.symbols) {
                    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Cargando...</p></div>';
                    return;
                }

                let symbolsToDisplay = this.data.symbols.symbols;
                
                // Filtrar por tier si no es 'ALL'
                if (this.currentTier !== 'ALL') {
                    symbolsToDisplay = symbolsToDisplay.filter(symbol => symbol.tier === this.currentTier);
                }

                const table = document.createElement('table');
                table.className = 'table';
                
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>S√≠mbolo</th>
                            <th>Tier</th>
                            <th>Expected Return</th>
                            <th>Max Drawdown</th>
                            <th>Win Rate Target</th>
                            <th>Leverage</th>
                            <th>Volatilidad</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${symbolsToDisplay.map(symbol => `
                            <tr>
                                <td><strong>${symbol.symbol}</strong></td>
                                <td><span class="tier-badge tier-${symbol.tier.toLowerCase().replace('tier', '')}">${symbol.tier}</span></td>
                                <td>${(symbol.performance.expected_daily_return * 100).toFixed(1)}%</td>
                                <td>${(symbol.performance.max_drawdown * 100).toFixed(1)}%</td>
                                <td>${(symbol.performance.win_rate_target * 100).toFixed(1)}%</td>
                                <td>${symbol.config.leverage_multiplier.toFixed(1)}x</td>
                                <td>${symbol.performance.volatility}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;

                container.innerHTML = `
                    <p><strong>Mostrando ${symbolsToDisplay.length} s√≠mbolos</strong> (${this.currentTier === 'ALL' ? 'Todos los tiers' : this.currentTier})</p>
                `;
                container.appendChild(table);
            }

            startRealTimeUpdates() {
                // Actualizar cada 10 segundos
                this.updateInterval = setInterval(async () => {
                    await this.loadTiers();
                    await this.checkMerkabaStatus();
                    await this.loadOpportunities();
                    this.updateDashboard();
                }, 10000);
            }

            destroy() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
            }
        }

        // Inicializar dashboard cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            window.qbtcDashboard = new QBTCDashboard();
        });
    </script>
    
    <!-- Cargar configuraci√≥n de s√≠mbolos -->
    <script src="config/symbols-extended.js"></script>
</body>
</html>
